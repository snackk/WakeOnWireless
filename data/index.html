<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>WoW Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="icon" type="image/png" href="favicon.png">
</head>
<body>
    <div class="topnav">
        <h1><i class="fas fa-desktop"></i> WoW - PC Controller</h1>
    </div>

    <div class="content">
        <div class="card-grid">
            <div class="card">
                <p class="card-title">
                    <i class="fas fa-power-off"></i>
                    Power Management
                </p>
              <div style="text-align: center; margin: 10px 0; display: flex; gap: 10px; justify-content: center;">
                  <button class="button-on" onclick="sendPowerCommand('ON')">
                      <i class="fas fa-plug"></i> Power Toggle
                  </button>
                  
                  <button class="button-off" style="background-color: #dc3545;" onclick="if(confirm('Force shutdown?')) sendPowerCommand('OFF')">
                      <i class="fas fa-skull-crossbones"></i> Force Off
                  </button>
              </div>
                <div class="state" style="margin-top: 15px;">
                    <span class="status-indicator" id="status-indicator"></span>
                    System State: <span class="value" id="pc-state">--</span>
                </div>
            </div>

            <div class="card">
                <p class="card-title">
                    <i class="fas fa-terminal"></i>
                    System Console
                </p>
                <div id="console-info" style="color: var(--text-secondary); line-height: 2;">
                    <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                        <p style="color: var(--text-secondary); margin-bottom: 20px;">
                            Monitor boot logs and hardware diagnostics in real-time.
                        </p>
                    </div>
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <a href="/console">
                        <button class="button-secondary" style="width: 100%;">
                            <i class="fas fa-code"></i> Open Terminal
                        </button>
                    </a>
                </div>
            </div>

            <div class="card">
                <p class="card-title">
                    <i class="fas fa-microchip"></i>
                    Controller Info
                </p>
                <div id="firmware-info" style="color: var(--text-secondary); line-height: 2;">
                    <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                        <p style="color: var(--text-secondary); margin-bottom: 20px;">
                            Firmware version: <span class="value" id="firmware-version">--</span>
                        </p>
                    </div>
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <a href="/update">
                        <button class="button-secondary" style="width: 100%;">
                            <i class="fas fa-sync-alt"></i> OTA Update
                        </button>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        function getFirmwareVersion() {
            fetch('/api/firmware')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('firmware-version').textContent = data.version;
                })
                .catch(err => console.error('Firmware fetch failed:', err));
        }

        // Update PC Power Status
        async function updateStatus() {
            const stateElement = document.getElementById('pc-state');
            const indicatorElement = document.getElementById('status-indicator');
            
            try {
                const response = await fetch('https://emby.snackk-media.com/', {
                    method: 'GET',
                    mode: 'cors' 
                });

                if (response.ok) {
                    stateElement.textContent = 'ON';
                    indicatorElement.className = 'status-indicator status-on';
                } else {
                    throw new Error('Server unreachable');
                }
            } catch (err) {
                console.error('PC is likely OFF or CORS blocked:', err);
                stateElement.textContent = 'OFF';
                indicatorElement.className = 'status-indicator status-off';
            }
        }
        
        // Trigger Power Action (Pulse Relay)
        function sendPowerCommand(action) {
            // Using your existing endpoint structure
            fetch(`/api/state/${action}`, {
                method: 'PUT'
            })
            .then(r => r.json())
            .then(data => {
                console.log('Command sent:', action);
                // Wait 1 second for hardware reaction before updating UI
                setTimeout(updateStatus, 1000);
            })
            .catch(err => console.error('Power command failed:', err));
        }
        
        // Auto-refresh status every 10 seconds
        setInterval(updateStatus, 10000);
        
        // Initial calls
        updateStatus();
        getFirmwareVersion();
    </script>
</body>
</html>